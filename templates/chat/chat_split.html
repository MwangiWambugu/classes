{% extends "base.html" %}
{% load static %}

  <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">
{% block content %}
  <style>
    body { font-family: Inter, sans-serif; background:#f6f8fb; margin:0; padding:0; }
    .split { display:flex; height:100vh; }
    .left { width: 320px; border-right:1px solid #e6e9ef; overflow:auto; background:#fff; padding:16px; }
    .right { flex:1; display:flex; flex-direction:column; padding:16px; }
    .channel-item { padding:10px;border-radius:8px; margin-bottom:6px; cursor:pointer; }
    .channel-item:hover { background:#f0f6ff; }
    .channel-item.active { background:#e7f0ff; font-weight:600; color:#0d6efd; }
    .chat-box { flex:1; background:#ffffff; border-radius:8px; padding:12px; overflow:auto; border:1px solid #e6e9ef; }
    .message { margin-bottom:10px; }
    .message .meta { font-size:12px; color:#6b7280; }
    .composer { display:flex; gap:8px; margin-top:12px; }
    .composer input { flex:1; padding:10px; border-radius:8px; border:1px solid #dfe6f2; }
    .composer button { padding:10px 16px; border-radius:8px; background:#0d6efd; color:white; border:none; }
    .create-form { display:flex; gap:8px; margin-top:12px; }
  </style>
</head>
<body>
<div class="split">
  <div class="left">
    <h4>Channels</h4>
    <div id="channelsList">
      {% for ch in channels %}
        <div class="channel-item {% if current and ch.id == current.id %}active{% endif %}" data-name="{{ ch.name }}">
          {{ ch.name }}
        </div>
      {% empty %}
        <p>No channels yet</p>
      {% endfor %}
    </div>

    <form id="createChannelForm" class="create-form" method="post" action="{% url 'create_channel' %}">
      {% csrf_token %}
      <input type="text" name="room_name" placeholder="New channel" required>
      <button type="submit">Create</button>
    </form>
  </div>

  <div class="right">
    <div>
      <h3 id="roomTitle">{% if current %}{{ current.name }}{% else %}No channel{% endif %}</h3>
    </div>
    <div id="chatBox" class="chat-box">
      {% if messages %}
        {% for msg in messages %}
          <div class="message">
            <strong>
    {% if msg.user %}
        {{ msg.user.username }}
    {% else %}
        Anonymous
    {% endif %}
</strong>
            <div>{{ msg.content }}</div>
            <div class="meta">{{ msg.timestamp }}</div>
          </div>
        {% endfor %}
      {% endif %}
    </div>

    <div class="composer">
      <input id="messageInput" type="text" placeholder="Type a message..." />
      <button id="sendBtn">Send</button>
    </div>
  </div>
</div>

<script>
(function () {
  const channelsList = document.getElementById("channelsList");
  const chatBox = document.getElementById("chatBox");
  const roomTitle = document.getElementById("roomTitle");
  const msgInput = document.getElementById("messageInput");
  const sendBtn = document.getElementById("sendBtn");

  let currentRoom = "{% if current %}{{ current.name }}{% endif %}";
  let socket = null;

  // --- Fetch messages dynamically when switching channels ---
  async function loadMessages(roomName) {
    try {
      const response = await fetch(`/chat/api/messages/${roomName}/`);
      if (!response.ok) throw new Error("Failed to fetch messages");
      const data = await response.json();

      chatBox.innerHTML = "";
      data.messages.forEach((msg) => {
        appendMessage(msg.username, msg.content, msg.timestamp);
      });
    } catch (err) {
      console.error("Error loading messages:", err);
    }
  }

  // --- Handle clicking on channel list ---
  channelsList.addEventListener("click", (e) => {
    const item = e.target.closest(".channel-item");
    if (!item) return;

    const roomName = item.dataset.name;
    if (roomName === currentRoom) return; // no need to reload same room

    document.querySelectorAll(".channel-item").forEach((el) => {
      el.classList.toggle("active", el.dataset.name === roomName);
    });

    joinRoom(roomName);
  });

  // --- Switch to a room ---
  function joinRoom(roomName) {
    if (!roomName) return;
    currentRoom = roomName;
    roomTitle.textContent = roomName;
    chatBox.innerHTML = "";

    // Update URL (optional, just for user experience)
    history.replaceState(null, "", `?room_name=${encodeURIComponent(roomName)}`);

    // Load messages dynamically
    loadMessages(roomName);

    // Connect to WebSocket
    connectSocket(roomName);
  }

  // --- WebSocket setup ---
  function connectSocket(roomName) {
    if (socket) {
      try {
        socket.close();
      } catch (e) {}
      socket = null;
    }

    const protocol = window.location.protocol === "https:" ? "wss" : "ws";
    const wsUrl = `${protocol}://${window.location.host}/ws/chat/${encodeURIComponent(
      roomName
    )}/`;
    socket = new WebSocket(wsUrl);

    socket.onopen = () => console.log("✅ WebSocket connected:", wsUrl);
    socket.onmessage = (e) => {
      const data = JSON.parse(e.data);
      appendMessage(data.username, data.message, data.timestamp);
    };
    socket.onclose = () => console.log("❌ WebSocket closed");
  }

  // --- Append message to chat ---
  function appendMessage(username, text, timestamp) {
    const div = document.createElement("div");
    div.className = "message";
    div.innerHTML = `
      <div><strong>${username || "Anonymous"}</strong></div>
      <div>${text}</div>
      <div class="meta">${timestamp}</div>
    `;
    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  // --- Send message through WebSocket ---
  sendBtn.addEventListener("click", () => {
    const text = msgInput.value.trim();
    if (!text || !currentRoom || !socket || socket.readyState !== WebSocket.OPEN) return;

    const payload = {
      message: text,
      username: "{% if request.user.is_authenticated %}{{ request.user.username }}{% else %}Anonymous{% endif %}",
    };
    socket.send(JSON.stringify(payload));
    msgInput.value = "";
  });

  msgInput.addEventListener("keypress", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      sendBtn.click();
    }
  });

  // --- Initial load ---
  if (currentRoom) {
    joinRoom(currentRoom);
  }
})();
</script>
{% endblock %}